{% extends "base.html" %}
{% load static %}
{% load form_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
{% endblock %}

{% block content %}

<div class="form-container">
  <div class="form-header">
    <h1 class="form-title">Editar Ve√≠culo</h1>
    <p class="form-subtitle">Atualize as informa√ß√µes do seu ve√≠culo</p>
  </div>

  <form method="post" enctype="multipart/form-data" id="car-form" class="form-card">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger" style="margin: 1.5rem;">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="form-section">
      <h2 class="section-title">
        <span class="material-symbols-outlined">directions_car</span>
        Informa√ß√µes do Ve√≠culo
      </h2>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label" for="{{ form.brand.id_for_label }}">Marca</label>
          {{ form.brand|add_class:"form-select" }}
          {% if form.brand.errors %}
            <div class="form-errors">{{ form.brand.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label" for="{{ form.model.id_for_label }}">Modelo</label>
          {{ form.model|add_class:"form-input" }}
          {% if form.model.errors %}
            <div class="form-errors">{{ form.model.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label" for="{{ form.factory_year.id_for_label }}">Ano de Fabrica√ß√£o</label>
          {{ form.factory_year|add_class:"form-input" }}
          {% if form.factory_year.errors %}
            <div class="form-errors">{{ form.factory_year.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label" for="{{ form.model_year.id_for_label }}">Ano do Modelo</label>
          {{ form.model_year|add_class:"form-input" }}
          {% if form.model_year.errors %}
            <div class="form-errors">{{ form.model_year.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label" for="{{ form.plate.id_for_label }}">Placa</label>
          {{ form.plate|add_class:"form-input" }}
          {% if form.plate.errors %}
            <div class="form-errors">{{ form.plate.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label" for="{{ form.color.id_for_color }}">Cor</label>
          {{ form.color|add_class:"form-input" }}
          {% if form.color.errors %}
            <div class="form-errors">{{ form.color.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label" for="{{ form.mileage.id_for_label }}">Quilometragem (km)</label>
          {{ form.mileage|add_class:"form-input" }}
          {% if form.mileage.errors %}
            <div class="form-errors">{{ form.mileage.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label" for="{{ form.price.id_for_label }}">Pre√ßo (R$)</label>
          {{ form.price|add_class:"form-input" }}
          {% if form.price.errors %}
            <div class="form-errors">{{ form.price.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label" for="{{ form.state.id_for_label }}">Estado</label>
          {{ form.state|add_class:"form-select" }}
          {% if form.state.errors %}
            <div class="form-errors">{{ form.state.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group full-width">
          <label class="form-label" for="{{ form.bio.id_for_label }}">Descri√ß√£o</label>
          {{ form.bio|add_class:"form-textarea" }}
          {% if form.bio.errors %}
            <div class="form-errors">{{ form.bio.errors }}</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="form-section">
      <h2 class="section-title">
        <span class="material-symbols-outlined">photo_camera</span>
        Fotos do Ve√≠culo
      </h2>

      <div class="images-section">
        <div class="upload-icon">
          <span class="material-symbols-outlined">cloud_upload</span>
        </div>
        <h3>Gerenciar fotos do ve√≠culo</h3>
        <p>Adicione at√© 10 fotos. Clique em "Principal" para definir a foto de capa.</p>
        <p><small><span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">smartphone</span> Arquivos HEIC (iPhone) ser√£o automaticamente convertidos para JPEG.</small></p>

        {{ formset.management_form }}

        <div class="image-upload-area" id="image-upload-area">
          {% for subform in formset %}
          <div class="image-slot {% if subform.instance.image %}has-image{% endif %}" data-form-index="{{ forloop.counter0 }}">
            {% if subform.instance.image %}
            <img src="{{ subform.instance.image.url }}" alt="Preview" class="image-preview">
            <div class="image-controls">
              <button type="button" class="btn-main {% if subform.instance.is_main %}active{% endif %}" onclick="setMainImage({{ forloop.counter0 }})">
                {% if subform.instance.is_main %}Principal{% else %}Principal{% endif %}
              </button>
              <button type="button" class="btn-remove" onclick="removeImage({{ forloop.counter0 }})">
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>
            {% if subform.instance.is_main %}
            <div class="main-image-indicator">PRINCIPAL</div>
            {% endif %}
            {% if subform.DELETE %}
            <div class="delete-checkbox" style="display: none;">
              {{ subform.DELETE }} {{ subform.DELETE.label_tag }}
            </div>
            {% endif %}
            {% else %}
            <div class="upload-placeholder">
              <div class="upload-icon">
                <span class="material-symbols-outlined">add_photo_alternate</span>
              </div>
              <div>Clique para adicionar foto</div>
            </div>
            {% endif %}

            <input type="file" class="hidden-input" accept="image/*,.heic,.HEIC" name="{{ subform.image.html_name }}" id="{{ subform.image.id_for_label }}">
            <input type="checkbox" name="{{ subform.is_main.html_name }}" id="{{ subform.is_main.id_for_label }}" style="display: none;" {% if subform.instance.is_main %}checked{% endif %}>
            {{ subform.id.as_hidden }}

            {% if subform.non_field_errors %}
            <div style="color: #dc3545; margin-top: 0.5rem; font-size: 0.875rem;">
              {{ subform.non_field_errors }}
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>

        {% if formset.non_form_errors %}
        <div style="color: #dc3545; margin-top: 1rem; text-align: center;">
          {{ formset.non_form_errors }}
        </div>
        {% endif %}
      </div>
    </div>

    <div class="submit-section">
      <a href="{% url 'car_detail' pk=object.pk %}" class="btn-cancel">
        <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 0.5rem;">arrow_back</span>
        Cancelar
      </a>
      <button type="submit" class="btn-submit">
        <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 0.5rem;">save</span>
        Salvar Altera√ß√µes
      </button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const imageSlots = document.querySelectorAll('.image-slot');
    let mainImageIndex = null;

    imageSlots.forEach((slot, index) => {
      const isMainBtn = slot.querySelector('.btn-main.active');
      if (isMainBtn) {
        mainImageIndex = index;
      }
    });

    imageSlots.forEach((slot, index) => {
      const input = slot.querySelector('input[type="file"]');
      const isMainInput = slot.querySelector('input[type="checkbox"][name$="-is_main"]'); slot.addEventListener('click', function (e) {
        if (!e.target.classList.contains('btn-remove') &&
          !e.target.classList.contains('btn-main') &&
          !e.target.type === 'checkbox') {
          input.click();
        }
      });

      input.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            displayImage(slot, e.target.result, index);
          };
          reader.readAsDataURL(file);
        }
      });
    });

    function displayImage(slot, src, index) {
      slot.classList.add('has-image');

      const fileInput = slot.querySelector('input[type="file"]');
      const isMainInput = slot.querySelector('input[type="checkbox"][name$="-is_main"]');
      const hiddenInputs = slot.querySelectorAll('input[type="hidden"]');
      const deleteCheckbox = slot.querySelector('.delete-checkbox');
      const deleteCheckboxHTML = deleteCheckbox ? deleteCheckbox.outerHTML : '';

      slot.innerHTML = `
            <img src="${src}" alt="Preview" class="image-preview">
            <div class="image-controls">
                <button type="button" class="btn-main" onclick="setMainImage(${index})">Principal</button>
                <button type="button" class="btn-remove" onclick="removeImage(${index})">√ó</button>
            </div>
            ${deleteCheckboxHTML}
        `;

      slot.appendChild(fileInput);
      slot.appendChild(isMainInput);
      hiddenInputs.forEach(input => slot.appendChild(input));

      if (mainImageIndex === null) {
        setMainImage(index);
      }
    }

    window.setMainImage = function (index) {
      document.querySelectorAll('.main-image-indicator').forEach(el => el.remove());
      document.querySelectorAll('.btn-main').forEach(btn => {
        btn.classList.remove('active');
        btn.textContent = 'Principal';
      });

      const slot = document.querySelector(`[data-form-index="${index}"]`);
      const isMainInput = slot.querySelector('input[type="checkbox"][name$="-is_main"]');
      const mainBtn = slot.querySelector('.btn-main'); if (isMainInput) {
        document.querySelectorAll('input[type="checkbox"][name$="-is_main"]').forEach(input => {
          input.checked = false;
        });
        isMainInput.checked = true;
        mainBtn.classList.add('active');
        mainBtn.textContent = 'Principal';

        const indicator = document.createElement('div');
        indicator.className = 'main-image-indicator';
        indicator.textContent = 'PRINCIPAL';
        slot.appendChild(indicator);

        mainImageIndex = index;
      }
    };

    window.removeImage = function (index) {
      const slot = document.querySelector(`[data-form-index="${index}"]`);
      const input = slot.querySelector('input[type="file"]');
      const isMainInput = slot.querySelector('input[type="checkbox"][name$="-is_main"]');
      const deleteCheckbox = slot.querySelector('input[name$="-DELETE"]');

      if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        slot.style.opacity = '0.5';
        slot.style.border = '2px solid #dc3545';
        return;
      }

      slot.classList.remove('has-image');

      const hiddenInputs = slot.querySelectorAll('input[type="hidden"]');

      slot.innerHTML = `
            <div class="upload-placeholder">
                <i>üì∑</i>
                <div>Clique para<br>adicionar foto</div>
            </div>
        `;

      input.value = '';
      isMainInput.checked = false;
      slot.appendChild(input);
      slot.appendChild(isMainInput);
      hiddenInputs.forEach(hiddenInput => slot.appendChild(hiddenInput));

      if (mainImageIndex === index) {
        mainImageIndex = null;
        const slotsWithImages = document.querySelectorAll('.image-slot.has-image');
        if (slotsWithImages.length > 0) {
          const firstSlotIndex = slotsWithImages[0].getAttribute('data-form-index');
          setMainImage(parseInt(firstSlotIndex));
        }
      }

      const newInput = slot.querySelector('input[type="file"]');
      newInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            displayImage(slot, e.target.result, index);
          };
          reader.readAsDataURL(file);
        }
      });

      slot.addEventListener('click', function (e) {
        if (!e.target.classList.contains('btn-remove') &&
          !e.target.classList.contains('btn-main') &&
          !e.target.type === 'checkbox') {
          newInput.click();
        }
      });
    };
  });
</script>

{% endblock %}